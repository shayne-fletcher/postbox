name: build and test
on:
  push:
  pull_request:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4.1.0
    - uses: SebRollen/toml-action@v1.0.2
      id: read_rust_toolchain
      with:
        file: rust-toolchain
        field: toolchain.channel
    - uses: dtolnay/rust-toolchain@v1
      with:
        toolchain: ${{ steps.read_rust_toolchain.outputs.value }}
        components: clippy, rustfmt
    - uses: Swatinem/rust-cache@v2
      id: build-cache
      with:
        shared-key: shared-build-cache
        cache-targets: true
        cache-all-crates: true
    - name: format check
      working-directory: '.'
      run: cargo fmt --all --check
    - name: clippy check
      working-directory: '.'
      run: cargo clippy --all-targets --all-features -- -D warnings -A clippy::new_without_default
    - name: build
      working-directory: '.'
      run: cargo build
      shell: bash
  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - uses: actions/checkout@v4.1.0
    - uses: SebRollen/toml-action@v1.0.2
      id: read_rust_toolchain
      with:
        file: rust-toolchain
        field: toolchain.channel
    - uses: dtolnay/rust-toolchain@v1
      with:
        toolchain: ${{ steps.read_rust_toolchain.outputs.value }}
        components: clippy, rustfmt
    - uses: Swatinem/rust-cache@v2
      id: test-cache
      with:
        shared-key: shared-build-cache
        cache-targets: true
        cache-all-crates: true
    - name: run tests
      working-directory: '.'
      run: cargo test
  coverage:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4.1.0
    - uses: SebRollen/toml-action@v1.0.2
      id: read_rust_toolchain
      with:
        file: rust-toolchain
        field: toolchain.channel
    - uses: dtolnay/rust-toolchain@v1
      with:
        toolchain: ${{ steps.read_rust_toolchain.outputs.value }}
        components: llvm-tools-preview
    - uses: Swatinem/rust-cache@v2
      id: coverage-cache
      with:
        shared-key: shared-build-cache
        cache-targets: true
        cache-all-crates: true
    - name: Install cargo-llvm-cov
      run: cargo install cargo-llvm-cov
    - name: Generate coverage
      run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info
    - name: Upload to codecov.io
      uses: codecov/codecov-action@v4
      with:
        files: lcov.info
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}
  publish-docs:
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - uses: actions/checkout@v4.1.0
    - uses: SebRollen/toml-action@v1.0.2
      id: read_rust_toolchain
      with:
        file: rust-toolchain
        field: toolchain.channel
    - uses: dtolnay/rust-toolchain@v1
      with:
        toolchain: ${{ steps.read_rust_toolchain.outputs.value }}
    - uses: Swatinem/rust-cache@v2
      id: docs-cache
      with:
        shared-key: shared-build-cache
        cache-targets: true
        cache-all-crates: true
    - name: build docs
      working-directory: '.'
      run: cargo doc --workspace --no-deps --all-features
    - name: add .nojekyll file
      working-directory: '.'
      run: touch target/doc/.nojekyll
    - name: copy mascot image and favicon
      working-directory: '.'
      run: |
        cp ottie.jpg target/doc/
        cp favicon.ico target/doc/
    - name: create workspace index
      working-directory: '.'
      run: |
        cat > target/doc/index.html <<'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>postbox - Documentation</title>
          <link rel="icon" type="image/x-icon" href="favicon.ico">
          <link rel="stylesheet" href="postbox/normalize1.81.0.css">
          <link rel="stylesheet" href="postbox/rustdoc1.81.0.css">
          <style>
            body { padding: 2rem; max-width: 900px; margin: 0 auto; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; }
            h1 { border-bottom: 1px solid #ddd; padding-bottom: 0.5rem; }
            .header-section { display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem; }
            .mascot { max-width: 200px; height: auto; border-radius: 8px; }
            .header-text { flex: 1; }
            .github-link { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem;
                          background: #24292e; color: white; text-decoration: none; border-radius: 6px;
                          font-weight: 500; margin-top: 1rem; }
            .github-link:hover { background: #1b1f23; }
            .quick-links { background: #f6f8fa; padding: 1.5rem; border-radius: 6px; margin: 2rem 0; }
            .quick-links h3 { margin-top: 0; }
            .quick-links ul { margin: 0.5rem 0; }
            .crate-list { list-style: none; padding: 0; }
            .crate-list li { margin: 1.5rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 4px; }
            .crate-list h2 { margin-top: 0; }
            .crate-list a { text-decoration: none; color: #0969da; }
            .crate-list a:hover { text-decoration: underline; }
            footer { margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #ddd;
                    color: #57606a; font-size: 0.875rem; text-align: center; }
            footer a { color: #0969da; text-decoration: none; }
            footer a:hover { text-decoration: underline; }
            @media (max-width: 600px) {
              .header-section { flex-direction: column; }
              .mascot { max-width: 150px; }
            }
          </style>
        </head>
        <body>
          <div class="header-section">
            <img src="ottie.jpg" alt="Ottie the Otter - postbox mascot" class="mascot">
            <div class="header-text">
              <h1>postbox workspace</h1>
              <p>Algebraic abstractions and computational tools for Rust.</p>
              <a href="https://github.com/shayne-fletcher/postbox" class="github-link">
                <svg height="16" width="16" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
                View on GitHub
              </a>
            </div>
          </div>

          <div class="quick-links">
            <h3>Quick Links</h3>
            <ul>
              <li>ðŸ“¦ <a href="https://github.com/shayne-fletcher/postbox">Source Repository</a></li>
              <li>ðŸ“– <a href="https://github.com/shayne-fletcher/postbox/blob/main/README.md">README</a></li>
              <li>ðŸ“„ <a href="https://github.com/shayne-fletcher/postbox/blob/main/LICENSE">License</a> (BSD-3-Clause)</li>
            </ul>
          </div>

          <h2>Crates</h2>
          <ul class="crate-list">
            <li>
              <h2><a href="algebra_core/index.html">algebra-core</a></h2>
              <p>Core algebraic abstractions: Semigroup, Monoid, Group, and Semilattice traits with implementations for std types.</p>
            </li>
            <li>
              <h2><a href="algebra_core_derive/index.html">algebra-core-derive</a></h2>
              <p>Derive macros for automatically implementing algebraic traits.</p>
            </li>
            <li>
              <h2><a href="autodiff/index.html">autodiff</a></h2>
              <p>Automatic differentiation: forward-mode AD with dual numbers, multivariable gradients, and reverse-mode AD (backpropagation).</p>
            </li>
            <li>
              <h2><a href="postbox/index.html">postbox</a></h2>
              <p>Lattice-based state library: concrete lattice types, LVars, MVars, CRDTs, and stream extensions built on algebra-core.</p>
            </li>
          </ul>

          <footer>
            <p>
              Copyright Â© 2025 Shayne Fletcher. Licensed under
              <a href="https://github.com/shayne-fletcher/postbox/blob/main/LICENSE">BSD-3-Clause</a>.
            </p>
          </footer>
        </body>
        </html>
        EOF
    - name: upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: target/doc
    - name: deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
